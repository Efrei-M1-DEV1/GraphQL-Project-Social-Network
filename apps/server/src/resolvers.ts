import type { DataSourceContext } from "./context";
import type { Resolvers } from "./types"; // Generated by GraphQL Codegen

export const resolvers: Resolvers = {
  Query: {
    hello: async () => {
      await new Promise((resolve) => setTimeout(resolve, 5000));
      return "Hello, GraphQL!";
    },
    users: async (_parent, _args, context: DataSourceContext) => {
      const users = await context.dataSources.db.user.findMany();
      return users.map((user) => ({
        ...user,
        createdAt: user.createdAt.toISOString(), // Convert Date to ISO string
        updatedAt: user.updatedAt.toISOString(), // Convert Date to ISO string
      }));
    },
    article: async (_parent, { id }, context: DataSourceContext) => {
      const article = await context.dataSources.db.article.findUnique({
        where: { id },
        include: { author: true },
      });
      if (!article) {
        return null;
      }
      return {
        ...article,
        createdAt: article.createdAt.toISOString(),
        updatedAt: article.updatedAt.toISOString(),
        author: {
          ...article.author,
          createdAt: article.author.createdAt.toISOString(),
          updatedAt: article.author.updatedAt.toISOString(),
        },
      };
    },
    articles: async (_parent, { first, after }, context: DataSourceContext) => {
      const articles = await context.dataSources.db.article.findMany({
        take: first || 10,
        skip: after || 0,
        orderBy: { createdAt: "desc" },
        include: { author: true },
      });
      return articles.map((article) => ({
        ...article,
        createdAt: article.createdAt.toISOString(),
        updatedAt: article.updatedAt.toISOString(),
        author: {
          ...article.author,
          createdAt: article.author.createdAt.toISOString(),
          updatedAt: article.author.updatedAt.toISOString(),
        },
      }));
    },
    articlesByAuthor: async (_parent, { authorId, first, after }, context: DataSourceContext) => {
      const articles = await context.dataSources.db.article.findMany({
        where: { authorId },
        take: first || 10,
        skip: after || 0,
        orderBy: { createdAt: "desc" },
        include: { author: true },
      });
      return articles.map((article) => ({
        ...article,
        createdAt: article.createdAt.toISOString(),
        updatedAt: article.updatedAt.toISOString(),
        author: {
          ...article.author,
          createdAt: article.author.createdAt.toISOString(),
          updatedAt: article.author.updatedAt.toISOString(),
        },
      }));
    },
  },
};
